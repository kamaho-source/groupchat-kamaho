services:
  groupchat-kamaho-app:
    container_name: groupchat-kamaho-app
    build:
      context: .
      dockerfile: ./docker/backend.Dockerfile
    ports:
      - "8000:80"
    volumes:
      - app-storage:/var/www/html/storage
    environment:
      TZ: "Asia/Tokyo"
      APP_ENV: production
      APP_DEBUG: "false"
      LOG_LEVEL: warning
      SESSION_DRIVER: file
      SANCTUM_STATEFUL_DOMAINS: localhost,localhost:80,localhost:3000,host.docker.internal:8000
      FRONTEND_URLS: http://localhost

  groupchat-kamaho-frontend:
    container_name: groupchat-kamaho-frontend
    build:
      context: .
      dockerfile: ./docker/frontend.Dockerfile
    ports:
      - "3000:3000"
    environment:
      - TZ=Asia/Tokyo
      - HOST=0.0.0.0
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    depends_on:
      - groupchat-kamaho-app

  groupchat-kamaho-nginx:
    container_name: groupchat-kamaho-nginx
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - groupchat-kamaho-frontend
      - groupchat-kamaho-app

  groupchat-kamaho-mysql:
    container_name: groupchat-kamaho-mysql
    build:
      context: .
      dockerfile: ./docker/database.Dockerfile
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: kamaho
      MYSQL_USER: kamaho
      MYSQL_PASSWORD: kamaho
      TZ: "Asia/Tokyo"
    volumes:
      - ./docker/mysql:/var/lib/mysql
      - ./database/log:/var/log/database
    platform: linux/amd64

volumes:
  app-storage:
