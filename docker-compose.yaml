services:
  groupchat-kamaho-app:
    container_name: groupchat-kamaho-app
    build:
      context: .
      dockerfile: ./docker/backend.Dockerfile
    ports:
      - "8000:80"
    environment:
      TZ: "Asia/Tokyo"
      LOG_LEVEL: warning
      SESSION_DRIVER: file
      SANCTUM_STATEFUL_DOMAINS: localhost,localhost:80,localhost:3000,localhost:8000,127.0.0.1:3000,127.0.0.1:8000,host.docker.internal:8000
      FRONTEND_URLS: http://localhost,http://localhost:3000,http://localhost:8000,http://127.0.0.1:3000,http://127.0.0.1:8000
      CORS_ALLOW_ALL: "true"
    # ğŸ”½ ãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒæœŸï¼ˆLaravel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
    volumes:
      - ./backend:/var/www/html:cached              # â† ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€å¼ã‚’åŒæœŸï¼ˆmacOSãªã‚‰ :cached / :delegated æ¨å¥¨ï¼‰
      - laravel-vendor:/var/www/html/vendor  # â† ãƒ›ã‚¹ãƒˆã®ç©ºvendorã§ä¸Šæ›¸ãã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
      - laravel-storage:/var/www/html/storage # â† æ›¸ãè¾¼ã¿å‘¨ã‚Šã‚’å®‰å®šã•ã›ãŸã„å ´åˆï¼ˆãƒ›ã‚¹ãƒˆã¨åŒæœŸã—ãŸã„ãªã‚‰ä¸‹è¨˜ã«å¤‰æ›´ï¼‰
    # ã‚‚ã— storage ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒæœŸã—ãŸã„ãªã‚‰ä¸Šã®2è¡Œã‚’ã“ã†ç½®æ›:
    #   - ./storage:/var/www/html/storage

  groupchat-kamaho-frontend:
    container_name: groupchat-kamaho-frontend
    build:
      context: .
      dockerfile: ./docker/frontend.Dockerfile
    ports:
      - "3000:3000"
    environment:
      - TZ=Asia/Tokyo
      - HOST=0.0.0.0
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - BACKEND_ORIGIN=http://groupchat-kamaho-app:80
      - NEXT_PUBLIC_API_BASE=/api
    depends_on:
      - groupchat-kamaho-app
    # ğŸ”½ ãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒæœŸï¼ˆNext.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
    volumes:
      - ./frontend:/app:cached                        # â† Dockerfile ã§ WORKDIR /app ã‚’æƒ³å®š
      - next-node-modules:/app/node_modules   # â† ãƒ›ã‚¹ãƒˆã® node_modules ã§ä¸Šæ›¸ãå›é¿
      - next-dotnext:/app/.next               # â† ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒœãƒªãƒ¥ãƒ¼ãƒ ã«ï¼ˆé«˜é€ŸåŒ–ãƒ»æ¨©é™äº‹æ•…å›é¿ï¼‰

  groupchat-kamaho-nginx:
    container_name: groupchat-kamaho-nginx
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - groupchat-kamaho-frontend
      - groupchat-kamaho-app

  groupchat-kamaho-mysql:
    container_name: groupchat-kamaho-mysql
    build:
      context: .
      dockerfile: ./docker/database.Dockerfile
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: kamaho
      MYSQL_USER: kamaho
      MYSQL_PASSWORD: kamaho
      TZ: "Asia/Tokyo"
    # DBã¯â€œåŒæœŸâ€ã‚ˆã‚Šâ€œæ°¸ç¶šåŒ–â€ãŒç›®çš„ãªã®ã§ named volume ã‚’æ¨å¥¨
    volumes:
      - mysql-data:/var/lib/mysql
      - ./database/log:/var/log/database
    platform: linux/amd64

volumes:
  # Laravel
  laravel-vendor:
  laravel-storage:
  # Next.js
  next-node-modules:
  next-dotnext:
  # MySQL
  mysql-data:
